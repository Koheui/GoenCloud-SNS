rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    match /users/{uid} {
      allow read, create, update: if request.auth.uid == uid;
      match /tokenTransactions/{txId} {
        allow read: if request.auth.uid == uid || request.auth.token.admin == true;
        allow create: if request.auth.uid == uid;
      }
      match /approvedSpaces/{spaceId} {
        allow read: if request.auth.uid == uid;
      }
    }

    match /spaces/{spaceId} {
      allow read: if true;
      allow write: if request.auth.uid == resource.data.ownerUid;
      match /relations/{otherUid} {
        allow read, create, update, delete: if request.auth != null;
      }
      match /footprints/{visitorUid} {
        allow read: if true;
        allow create, update: if request.auth.uid == visitorUid;
      }
      match /timeline/{itemId} {
        allow read: if true;
        allow write: if request.auth.uid == get(/databases/$(db)/documents/spaces/$(spaceId)).data.ownerUid;
      }
      match /music/{trackId} {
        allow read: if true;
        allow write: if request.auth.uid == get(/databases/$(db)/documents/spaces/$(spaceId)).data.ownerUid;
      }
    }

    match /posts/{postId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.ownerUid;
    }

    match /condolences/{id} {
      allow read: if true;
      allow create: if false; // Functions 経由のみ
    }
  }
}

